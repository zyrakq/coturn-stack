# 🔄 COTURN

A modular Docker Compose configuration system for COTURN TURN/STUN server with support for multiple environments and SSL certificate management.

## 🚀 Quick Start

### 1. Build Configurations

Use the stackbuilder utility to build all configurations:

```bash
sb build
```

This will create all combinations in the `build/` directory based on [`stackbuilder.toml`](stackbuilder.toml).

### 2. Choose Your Configuration

Navigate to the desired configuration directory:

```bash
# For basic deployment
cd build/basic/

# For production with Let's Encrypt SSL
cd build/letsencrypt/

# For production with Step CA SSL
cd build/step-ca/
```

### 3. Configure Environment

Copy and edit the environment file:

```bash
cp .env.example .env
# Edit .env with your values
```

### 4. Deploy

Start the services:

```bash
docker compose up --build -d
```

## 📁 Project Structure

- **`build/`** - Final Docker Compose configurations ready to deploy
- **`components/`** - Source components used to build final configurations
  - `base/` - Base COTURN components
  - `environments/` - Environment components (basic, letsencrypt, step-ca)

The `build/` directory contains ready-to-use configurations generated by `sb build` command. The `components/` directory contains the source files that are combined to create these final configurations.

## 🔧 Available Configurations

### Environments

- **basic**: Simple deployment with host networking
- **letsencrypt**: Production with Let's Encrypt SSL certificates
- **step-ca**: Production with Step CA SSL certificates

## 🔐 Environment Variables

### Base Configuration

- `COMPOSE_PROJECT_NAME`: Project name for Docker Compose
- `COTURN_SECRET_KEY`: Secret key for TURN server authentication
- `COTURN_DOMAIN`: Your domain/realm (e.g., example.com)

### SSL Configuration (Let's Encrypt & Step CA)

- `cert=/certs/${COTURN_DOMAIN}/fullchain.pem`: SSL certificate path
- `pkey=/certs/${COTURN_DOMAIN}/key.pem`: SSL private key path

## 🌐 Deployment Scenarios

### Basic Deployment

```bash
# Simple COTURN server
cd src/coturn/build/basic/
docker-compose up -d
```

### Production Environment

```bash
# COTURN with Let's Encrypt SSL
cd src/coturn/build/letsencrypt/
docker-compose up -d

# COTURN with Step CA SSL
cd src/coturn/build/step-ca/
docker-compose up -d
```

## 🔒 Security Features

- **Authentication**: Secret-based authentication for TURN connections
- **SSL/TLS Encryption**: Automatic certificate management with Let's Encrypt or Step CA
- **Network Security**: Host networking mode for optimal performance
- **Secret Management**: Environment-based configuration

## 🎯 COTURN Features

- **Docker-based**: Containerized deployment with official COTURN image
- **Authentication**: Secure access with secret-based auth
- **Multiple Protocols**: Supports both TCP and UDP for STUN/TURN
- **SSL Support**: Automatic SSL certificate management
- **Production-ready**: Configured for real-world usage
- **Simple Configuration**: Environment-based setup

## 🔧 Configuration

### Ports

| Port | Protocol | Description |
|------|----------|-------------|
| `3478` | TCP/UDP | STUN/TURN server |
| `5349` | TCP/UDP | STUN/TURN over TLS |
| `49152-65535` | UDP | Media relay ports |

### TURN Server Configuration

The COTURN server is configured with:

- **Authentication**: Secret-based authentication using `static-auth-secret`
- **Realm**: Domain-based realm configuration
- **SSL Certificates**: Automatic certificate management for secure connections
- **Logging**: Structured logging with rotation

## 🛠️ Management

### View logs

```bash
docker logs coturn
```

### Restart service

```bash
docker-compose restart coturn
```

### Stop service

```bash
docker-compose down
```

## 🔍 Usage

### Testing the Server

You can test your COTURN server using online STUN/TURN testers or WebRTC applications.

### Integration

Use the following configuration in your WebRTC applications:

```javascript
const iceServers = [
  {
    urls: 'stun:your-domain.com:3478'
  },
  {
    urls: 'turn:your-domain.com:3478',
    username: 'your-username',
    credential: 'your-secret-key'
  }
];
```

## 🔒 Security Considerations

- 🔑 Use a strong, randomly generated secret key
- 🌐 Configure proper firewall rules for ports 3478, 5349, and 49152-65535
- 🔄 Regularly update the COTURN image
- 📊 Monitor server usage and logs
- 🔒 Enable SSL/TLS for production deployments

## 🆘 Troubleshooting

### Common Issues

- **SSL Certificate Issues**: Check Let's Encrypt/Step CA configuration and certificate paths
- **Network Connectivity**: Ensure proper firewall configuration for TURN ports
- **Authentication Issues**: Verify secret key configuration
- **Port Conflicts**: Check that required ports are available

### Logs

```bash
# COTURN logs
docker logs coturn

# Check for specific errors
docker logs coturn 2>&1 | grep -i error
```

### Testing Connectivity

```bash
# Test STUN functionality
turnutils_stunclient your-domain.com

# Test TURN functionality
turnutils_uclient -u your-username -w your-secret-key your-domain.com
```

## 📚 Resources

- [COTURN Official Documentation](https://github.com/coturn/coturn)
- [WebRTC Documentation](https://webrtc.org/)
- [Docker Compose Reference](https://docs.docker.com/compose/)
- [Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [Step CA Documentation](https://smallstep.com/docs/step-ca/)

## 🔗 Integration

### Matrix Homeserver Integration

COTURN can be integrated with Matrix homeservers like Conduit for voice and video calling:

```bash
# Example Matrix TURN configuration
CONDUIT_TURN_URIS='["turns:your-domain.com?transport=udp", "turns:your-domain.com?transport=tcp"]'
# OR turn:your-domain.com for without TLS
CONDUIT_TURN_SECRET=your-coturn-secret-key
```

### WebRTC Application Integration

Popular WebRTC applications that can use COTURN:

- **Matrix Clients**: Element, Cinny, FluffyChat
- **Video Conferencing**: Jitsi, BigBlueButton
- **Communication Platforms**: Nextcloud Talk, Mattermost

## 📄 License

This project is dual-licensed under:

- Apache License 2.0
- MIT License

Choose the license that best fits your needs! 🎉

## 🤝 Contributing

Contributions are welcome! Please feel free to submit issues and pull requests.

---

Made with ❤️ for the WebRTC community
